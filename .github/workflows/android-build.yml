
name: 打包并预发布release

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > keystore.jks
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}

      - name: Get versionName from Gradle (resolved value)
        id: version
        run: |
          # Use the Gradle task added to app/build.gradle.kts to print the computed version name.
          # -q silences extra Gradle output, leaving only the printed version on stdout.
          VERSION=$(./gradlew -q :app:printVersionName)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Validate version output
        run: |
          # Fail early if version output is empty or doesn't look like a semantic-like version
          if [ -z "${{ steps.version.outputs.version }}" ]; then
            echo "Version output is empty" >&2
            exit 1
          fi
          if ! echo "${{ steps.version.outputs.version }}" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "Version does not match expected pattern (major.minor.patch)" >&2
            exit 1
          fi


      - name: Build debug APK
        run: ./gradlew assembleDebug
        env:
          KEYSTORE_PATH: keystore.jks
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Upload signed universal debug APK
        uses: actions/upload-artifact@v4
        with:
          name: universal-debug-signed-apk
          path: app/build/outputs/apk/debug/app-debug.apk

      - name: Build release APKs (split by ABI)
        run: ./gradlew assembleRelease
        env:
          KEYSTORE_PATH: keystore.jks
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: Upload signed release APKs
        uses: actions/upload-artifact@v4
        with:
          name: release-signed-apks
          path: app/build/outputs/apk/release/*-release.apk

      - name: Create GitHub Pre-release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.version }}
          prerelease: true
          files: |
            app/build/outputs/apk/release/*-release.apk
            app/build/outputs/apk/debug/app-debug.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
